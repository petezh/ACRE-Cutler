---
title: "R Notebook"
output: html_notebook
---

```{r setup, include=FALSE} 
# Loading required libraries
list.of.packages <- c("ggplot2", "tidyverse", "kableExtra", "here")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages, repos= "https://cran.r-project.org/")

lapply(list.of.packages, library, character.only = TRUE)

knitr::opts_knit$set(root.dir = here())
knitr::opts_chunk$set(echo = TRUE)

print_code <- TRUE
``` 

```{r sources, eval = TRUE, echo=print_code, message=FALSE, warning=FALSE}
# - inputs: none
# - outputs: all sources coming from data, research and guesswork

chunk_sources <- function(){
  
  
    #############
    ##### Data  
    #############
  
  # load GDP projections
  GDP_so <- read.csv("data/analysis/projections.csv")
  
  # load COVID deaths data
  deaths_so <- read.csv("data/analysis/covid_deaths.csv")
  deaths_so$End.Date <- as.Date(deaths_so$End.Date, "%m/%d/%Y")
  deaths_so <- subset(deaths_so, End.Date <= as.Date("2020-09-25"))
  
  # load COVID impairment data
  impairments_so <- read.csv("data/analysis/impairments.csv")
  
  # load COVID deaths data
  mentalhealth_so <- read.csv("data/analysis/mental_health.csv")
  
    #############
    ##### Research
    #############
  
  # based on estimates
  VSL_so <- 7000000
  VLY_so <- 100000
  
  # based on research/estimates
  currentdeaths_so <- 190076
  weeklydeaths_so <- 5000
  excessdeaths_so <- 1.38888
  
  # based on estimate
  futureratio_so <- 625000/250000
  
  # based on research/estimates
  complications_so <- 1/3
  impQOLloss_so <- 0.35
  
  # based on data
  adultpop_so = 263000000
  mhQOLloss_so <- 0.2
  
  return(list("GDP_so"=GDP_so,
              "deaths_so"=deaths_so,
              "impairments_so"=impairments_so,
              "mentalhealth_so"=mentalhealth_so,
              "VSL_so"=VSL_so,
              "VLY_so"=VLY_so,
              "currentdeaths_so"=currentdeaths_so,
              "weeklydeaths_so"=weeklydeaths_so,
              "excessdeaths_so"=excessdeaths_so,
              "futureratio_so"=futureratio_so,
              "complications_so"=complications_so,
              "ImpQOLloss_so"=impQOLloss_so,
              "adultpop_so"=adultpop_so,
              "mhQOLloss_so"=mhQOLloss_so))
}
invisible(list2env(chunk_sources(),.GlobalEnv) )  
```

# Introduction

This is a reproduction package for _The COVID-19 Pandemic and the $16 Trillion Virus_ by Cutler and Summers. It is based on elements from the Open Policy Analysis [template](https://github.com/BITSS-OPA/opa-deworming).

# Methodology

The total cost of the pandemic is calculated as the total value of GDP losses, premature deaths, long-term health impairments, and mental health harms.

```{r test, eval=FALSE}
# - inputs: none
# - outputs: equation for computing total value
chunk_test <- function(){
############################################################################### 
###############################################################################  
  
    mainequation_f <- function(GDP_var = GDP_pe,
                               deaths_var = deaths_pe,
                               impairments_var = impairments_pe,
                               mentalhealth_var = mentalhealth_pe) {
        return(GDP_var + deaths_var + impairments_var + mentalhealth_var)
    }
    
    
############################################################################### 
###############################################################################  
    return(list("mainequation_f" = mainequation_f))    # Try to return only functions
}
invisible( list2env(chunk_test(),.GlobalEnv) )
```


## Component 1: GDP

This method to calculate GDP losses.

```{r comp1}
# - inputs: pre-COVID and post-COVID GDP projection
# - output: plot of projections, sum of losses
chunk_calc_GDP <- function(GDP_var = GDP_so){
  GDP_plot <- ggplot(data = GDP_var, aes(x = Year)) + 
    geom_line(aes(y = Pre.Covid), color = "blue") + 
    geom_line(aes(y = Post.Covid), color="orangered") 
  GDP_pe = sum(GDP_var$Pre.Covid-GDP_var$Post.Covid)*1000000000
return (list("GDP_plot"=GDP_plot,
             "GDP_pe"=GDP_pe))
}   
invisible( list2env(chunk_calc_GDP(),.GlobalEnv) )
plot1 <- GDP_plot +
      labs(y = "Real GDP in $ Billions",
       x = "Year" ,
       title = "Change in GDP",
       subtitle = "January 2020 and July 2020 GBO Projections"
       ) 
plot1
GDP_pe
```

## Component 2: Deaths

```{r comp2}
# - inputs: death factors
# - output: plot of covid-19 deaths, value of premature deaths
chunk_calc_deaths <- function(deaths_var = deaths_so,
                         currentdeaths_var = currentdeaths_so,
                         weeklydeaths_var = weeklydeaths_so,
                         excessdeaths_var = excessdeaths_so,
                         VSL_var = VSL_so){
  
  deaths_plot <- ggplot(data = deaths_so, aes(x = End.Date, y = COVID.19.Deaths)) + 
    geom_line(color='blue')
  deaths_pe <- (currentdeaths_var + 52*weeklydeaths_var) * excessdeaths_var * VSL_var
  
return (list("deaths_plot"=deaths_plot,
             "deaths_pe"=deaths_pe))
}  
invisible( list2env(chunk_calc_deaths(),.GlobalEnv) )
plot2 <- deaths_plot +
      labs(y = "Weekly COVID-19 Deaths",
       x = "Month" ,
       title = "Number of COVID-19 Deaths",
       subtitle = "Based on estimates from the CDC"
       ) 
plot2
deaths_pe
```

## Component 3: Impairmnets

```{r comp3}
# - inputs: impairment factors
# - output: value of impairments
chunk_calc_impairments <- function(impairments_var = impairments_so$Impairments,
                                   futureratio_var = futureratio_so,
                                   complications_var = complications_so,
                                   impQOLloss_var = impQOLloss_so,
                                   VSL_var = VSL_so){
  impairments_pe <- sum(impairments_var) * futureratio_var * complications_var * impQOLloss_var * VSL_var 
return (list("impairments_pe"=impairments_pe))
}  
invisible(list2env(chunk_calc_impairments(),.GlobalEnv) )
impairments_pe
```

## Component 4: Mental Health

```{r comp4}
# - inputs: pre-COVID and post-COVID GDP projection
# - output: plot of projections, sum of losses
chunk_calc_mentalhealth <- function(mentalhealth_var = mentalhealth_so,
                                   adultpop_var = adultpop_so,
                                   mhQOLloss_var = mhQOLloss_so,
                                   VLY_var = VLY_so){
  anx_dep_2019 <- mentalhealth_var[which(mentalhealth_var$Indicator == 'Symptoms of anxiety disorder and/or depressive disorder' & mentalhealth_var$Time.Period == '2019'),]$Value
  anx_dep_2020 <- mentalhealth_var[which(mentalhealth_var$Indicator == 'Symptoms of Anxiety Disorder or Depressive Disorder' & mentalhealth_var$Time.Period == 'July 16 - July 21'),]$Value
  anx_dep_increase <- anx_dep_2020 - anx_dep_2019
  mentalhealth_pe <- anx_dep_increase / 100 * adultpop_var * mhQOLloss_var * VLY_var
return (list("mentalhealth_pe"= mentalhealth_pe))
}  
invisible(list2env(chunk_calc_mentalhealth(),.GlobalEnv) )
mentalhealth_pe
```

# Main Results

```{r}
mainequation_in <- mainequation_f()
results_table <- data.frame("Lost GDP" =   c(GDP_pe, NA,
                                             NA) ,
                        "Premature death" =  c(deaths_pe, "results", NA),
                        "Long-term health impairment" = c(impairments_pe, NA,
                                             "results"),
                        "Mental healh impariment" = c(mentalhealth_pe, NA,
                                             "results"),
                        "Total" = c(mainequation_in, NA, NA),
                        "Total for a family of 4" = c(mainequation_in, NA, NA),
                        
                        row.names = c("situation1", "situation2", "situation3"))

kable(results_table, caption = "Table Caption") %>%
  kable_styling("striped", full_width = F)
```


